<html>
<head>
  <style>
    input {
      font-family: monospace;
      text-align: right;
    }
  </style>
  <script src="http://localhost:35729/livereload.js?snipver=1"></script>
  <script src="node_modules/keysim/dist/keysim.js"></script>
  <script src="node_modules/chai/chai.js"></script>
  <script src="node_modules/mocha/mocha.js"></script>
  <link  href="node_modules/mocha/mocha.css" rel="stylesheet" />
</head>
<body>
<div id="mocha"></div>
<div>
  <input id="num" type="text"/> -> <input id="num_out" type="text" readonly disabled/>
</div>
<div>
  <input id="start" type="text" readonly disabled/> -> <input id="end" type="text" readonly disabled/>
</div>
<script>
  function reverse(string) {
    return string.split("").reverse().join("");
  }
  function format(value, separator) {
    return value.length === 0
        ? ""
        : reverse(reverse(value.replace(/,/g, "")).match(/.{1,3}/g).join(separator));
  }
  function inject(string, character, positionFromLeft) {
    return (string.slice(0, positionFromLeft) + character + string.slice(positionFromLeft));
  }
  function strip(string) {
    return string.replace(/[^0-9]/g, '');
  }
  function backspace(el, separator) {
    const value = el.value;
    const start = el.selectionStart;
    const end = el.selectionEnd;
    const length = end - start;
    const rightOfSeparator = start > 0 && value[start - 1] === separator[separator.length - 1];
    const separatorWillBeRemovedLeftOfSelection = value[1] === separator[0];
    const caretPosition = Math.max(0, start - (length ? 0  : 1));

    return {
      caret: caretPosition - (separatorWillBeRemovedLeftOfSelection ? 1 : 0),
      value: value.slice(0, caretPosition - (rightOfSeparator ? separator.length : 0)) + value.slice(end, value.length)
    };
  }

  const DelimitedInput = function(separator) {
    return function(event) {
      const priorPosition = event.target.selectionStart;
      const key = String.fromCharCode(event.keyCode);

      if (/[0-9]/.test(key)) {
        event.preventDefault();

        const value = event.target.value;
        event.target.value = format(inject(value, key, priorPosition), separator);

        const shift = event.target.value.length - value.length;

        event.target.selectionStart = priorPosition + shift;
        event.target.selectionEnd = priorPosition + shift;
      } else if (event.keyCode === 8) {
        event.preventDefault();
        const result = backspace(event.target, separator);
        event.target.value = format(result.value, separator);
        event.target.selectionStart = event.target.selectionEnd = result.caret;
      }
    }
  };

  const captureResult = function(func) {
    return function(event) {
      const result = func(event);
      document.getElementById("num_out").value = strip(event.target.value);
      document.getElementById("start").value = event.target.selectionStart;
      document.getElementById("end").value = event.target.selectionEnd;
      return result;
    };
  };

  document
      .getElementById("num")
      .addEventListener("keydown", captureResult(DelimitedInput(",")));
</script>
<script>
  mocha.setup('bdd');

  const assert = chai.assert;

  function input() {
    return document.getElementById('num');
  }
  function value() {
    return input().value;
  }
  function caret(index) {
    input().selectionStart = input().selectionEnd = index;
  }
  function selection(index, length) {
    input().selectionStart = index;
    input().selectionEnd = index + length;
  }

  const kb = Keysim.Keyboard.US_ENGLISH;
  describe('Input', function() {
    beforeEach(function() {
      input().value = '';
    });

    describe('value for thousand', function() {
      beforeEach(function() {
        kb.dispatchEventsForInput('1234', input());
      });

      it('sets delimiter after first number', function() {
        assert.equal(value(), '1,234');
      });

      describe('entering backspace in front of value', function() {
        beforeEach(function() {
          caret(0);
          kb.dispatchEventsForAction('backspace', input());
        });

        it('does not modify input', function() {
          assert.equal(value(), '1,234');
        });
      });
    });

    describe('value for 12,345', function() {
      beforeEach(function() {
        kb.dispatchEventsForInput('12345', input());
      });

      it('sets delimiter after second number', function() {
        assert.equal(value(), '12,345');
      });

      describe('selection over 2,3', function() {
        describe('entering backspace', function() {
          beforeEach(function() {
            selection(1, 3);
            kb.dispatchEventsForAction('backspace', input());
          });

          it('leaves 145', function() {
            assert.equal(value(), '145');
          });
        });
      });

      describe('selection over 12', function() {
        describe('entering backspace', function() {
          beforeEach(function() {
            selection(0, 2);
            kb.dispatchEventsForAction('backspace', input());
          });

          it('leaves 345', function() {
            assert.equal(value(), '345');
          });
        });
      });

      describe('selection over ,', function() {
        describe('entering backspace', function() {
          beforeEach(function() {
            selection(2, 1);
            kb.dispatchEventsForAction('backspace', input());
          });

          it('does not modify the input', function() {
            assert.equal(value(), '12,345');
          });
        });
      });
    });

    describe('value for 1,234,567', function() {
      beforeEach(function() {
        kb.dispatchEventsForInput('1234567', input());
      });

      describe('entering backspace', function() {
        describe('after first character', function() {
          beforeEach(function() {
            caret(1);
            kb.dispatchEventsForAction('backspace', input());
          });

          it('removes 1', function() {
            assert.equal(value(), '234,567');
          });

          it('selection start before value', function() {
            assert.equal(0, input().selectionStart);
          });

          it('selection length is zero', function() {
            assert.equal(input().selectionStart, input().selectionEnd);
          });
        });

        describe('after second separator', function() {
          beforeEach(function() {
            caret(6);
            kb.dispatchEventsForAction('backspace', input());
          });

          it('removes 4', function() {
            assert.equal(value(), '123,567');
          });

          it('selection start after separator', function() {
            assert.equal(4, input().selectionStart);
          });

          it('selection length is zero', function() {
            assert.equal(input().selectionStart, input().selectionEnd);
          });
        });

        describe('before second separator', function() {
          beforeEach(function() {
            caret(5);
            kb.dispatchEventsForAction('backspace', input());
          });

          it('removes 4', function() {
            assert.equal(value(), '123,567');
          });

          it('selection start before separator', function() {
            assert.equal(3, input().selectionStart);
          });

          it('selection length is zero', function() {
            assert.equal(input().selectionStart, input().selectionEnd);
          });
        });

        describe('after last character', function() {
          beforeEach(function() {
            caret(value().length);
            kb.dispatchEventsForAction('backspace', input());
          });

          it('removes 7', function() {
            assert.equal(value(), '123,456');
          });

          it('selection start at last character', function() {
            assert.equal(input().selectionStart, value().length);
          });

          it('selection length is zero', function() {
            assert.equal(input().selectionStart, input().selectionEnd);
          });
        });
      });
    });
  });

  mocha.run();
</script>
</body>
</html>
