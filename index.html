<html>
<head>
  <style>
    input {
      font-family: monospace;
      text-align: right;
    }
  </style>
  <script src="http://localhost:35729/livereload.js?snipver=1"></script>
  <script src="node_modules/keysim/dist/keysim.js"></script>
  <script src="node_modules/chai/chai.js"></script>
  <script src="node_modules/mocha/mocha.js"></script>
  <link  href="node_modules/mocha/mocha.css" rel="stylesheet" />
</head>
<body>
<div id="mocha"></div>
<input id="num" type="text"/> -> <input id="num_out" type="text" readonly disabled/>
<script>
  function reverse(string) {
    return string.split("").reverse().join("");
  }
  function format(value) {
    return value.length === 0
        ? ""
        : reverse(reverse(value.replace(/,/g, "")).match(/.{1,3}/g).join(thousandSeparator));
  }
  function inject(string, character, positionFromLeft) {
    return (string.slice(0, positionFromLeft) + character + string.slice(positionFromLeft));
  }
  function strip(string) {
    return string.replace(/[^0-9]/g, '');
  }
  function backspace(el, separator) {
    const value = el.value;
    const start = el.selectionStart;
    const end = el.selectionEnd;
    const nextToSeparator = start > 0 && value[start - 1] === separator[separator.length - 1];
    return value.slice(0, start - 1 - (nextToSeparator ? separator.length : 0)) + value.slice(end, value.length);
  }

  const out = document.getElementById("num_out");
  const el = document.getElementById("num");
  const thousandSeparator = ",";

  const listener = function(event) {
    const priorPosition = event.target.selectionStart;
    const key = String.fromCharCode(event.keyCode);

    if (/[0-9]/.test(key)) {
      event.preventDefault();

      const value = event.target.value;
      event.target.value = format(inject(value, key, priorPosition));

      const shift = event.target.value.length - value.length;

      event.target.selectionStart = priorPosition + shift;
      event.target.selectionEnd = priorPosition + shift;
    } else if (event.keyCode === 8) {
      event.preventDefault();
      event.target.value = format(backspace(event.target, thousandSeparator));
    }

    out.value = strip(event.target.value);
  };

  el.addEventListener("keydown", listener);
</script>
<script>
  mocha.setup('bdd');

  const assert = chai.assert;

  function input() {
    return document.getElementById('num');
  }
  function value() {
    return input().value;
  }
  function caret(index) {
    input().selectionStart = input().selectionEnd = index;
  }

  const kb = Keysim.Keyboard.US_ENGLISH;
  describe('Input', function() {
    beforeEach(function() {
      input().value = '';
    });

    describe('value for thousand', function() {
      beforeEach(function() {
        kb.dispatchEventsForInput('1234', input());
      });

      it('sets delimiter after first number', function() {
        assert.equal(value(), '1,234');
      });
    });

    describe('value for ten thousand', function() {
      beforeEach(function() {
        kb.dispatchEventsForInput('12345', input());
      });

      it('sets delimiter after second number', function() {
        assert.equal(value(), '12,345');
      });
    });

    describe('value for 1,234,567', function() {
      beforeEach(function() {
        kb.dispatchEventsForInput('1234567', input());
      });

      describe('entering backspace after', function() {
        describe('first character', function() {
          beforeEach(function() {
            caret(1);
            kb.dispatchEventsForAction('backspace', input());
          });

          it('removes 1', function() {
            assert.equal(value(), '234,567');
          });
        });

        describe('second separator', function() {
          beforeEach(function() {
            caret(6);
            kb.dispatchEventsForAction('backspace', input());
          });

          it('removes 4', function() {
            assert.equal(value(), '123,567');
          });
        });

        describe('last character', function() {
          beforeEach(function() {
            caret(value().length);
            kb.dispatchEventsForAction('backspace', input());
          });

          it('removes 7', function() {
            assert.equal(value(), '123,456');
          });
        });
      });
    });
  });

  mocha.run();
</script>
</body>
</html>
