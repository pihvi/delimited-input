<html>
<head>
  <style>
    input {
      font-family: monospace;
      text-align: right;
    }
  </style>
  <script src="http://localhost:35729/livereload.js?snipver=1"></script>
  <script src="node_modules/keysim/dist/keysim.js"></script>
  <script src="node_modules/chai/chai.js"></script>
  <script src="node_modules/mocha/mocha.js"></script>
  <link  href="node_modules/mocha/mocha.css" rel="stylesheet" />
</head>
<body>
<div id="mocha"></div>
<input id="num" type="text"/> -> <input id="num_out" type="text" readonly disabled/>
<script>
  function reverse(string) {
    return string.split("").reverse().join("");
  }
  function format(value) {
    return value.length === 0
        ? ""
        : reverse(reverse(value.replace(/,/g, "")).match(/.{1,3}/g).join(thousandSeparator));
  }
  function inject(string, character, positionFromLeft) {
    return (string.slice(0, positionFromLeft) + character + string.slice(positionFromLeft));
  }
  function strip(string) {
    return string.replace(/[^0-9]/g, '');
  }

  const out = document.getElementById("num_out");
  const el = document.getElementById("num");
  const thousandSeparator = ",";

  const listener = function(event) {
    const priorPosition = event.target.selectionStart;
    const key = String.fromCharCode(event.keyCode);

    if (/[0-9]/.test(key)) {
      event.preventDefault();

      const value = event.target.value;
      event.target.value = format(inject(value, key, priorPosition));

      const shift = event.target.value.length - value.length;

      event.target.selectionStart = priorPosition + shift;
      event.target.selectionEnd = priorPosition + shift;
    }

    out.value = strip(event.target.value);
  };

  el.addEventListener("keydown", listener);
</script>
<script>
  mocha.setup('bdd');

  const assert = chai.assert;

  function input() {
    return document.getElementById('num');
  }
  function value() {
    return input().value;
  }

  describe('Input', function() {
    const kb = Keysim.Keyboard.US_ENGLISH;
    beforeEach(function() {
      input().value = '';
    });

    describe('value for thousand', function() {
      beforeEach(function() {
        kb.dispatchEventsForInput('1234', input());
      });

      it('sets delimiter after first number', function() {
        assert.equal(value(), '1,234');
      });
    });

    describe('value for ten thousand', function() {
      beforeEach(function() {
        kb.dispatchEventsForInput('12345', input());
      });

      it('sets delimiter after second number', function() {
        assert.equal(value(), '12,345');
      });
    });
  });

  mocha.run();
</script>
</body>
</html>
